# Story: Finalize Praxis-Opinions Contract

**Project:** opinions-framework  
**Size:** Medium  
**Priority:** High (blocks CLI/integration work)  
**Depends on:** 03-draft-contract, 04-opinion-structure

### Budget (by size)

| Size | Time Box | AI Credit Budget |
|------|----------|------------------|
| Small | 30 min | ~20 queries |
| **Medium** | **60 min** | **~50 queries** |
| Large | 120 min | ~100 queries |

*This story is Medium.*

---

## Summary

Finalize the opinions ↔ Praxis contract based on learnings from the opinion structure story. This turns the draft contract into a production-ready specification.

---

## Problem Statement

The draft contract (Story 03) was intentionally incomplete to avoid over-specifying before validation. Now that opinion structure has been tested, we can finalize:

1. Refined schema based on actual opinion files
2. CLI integration design
3. AI agent integration pattern
4. Inheritance algorithm with edge cases
5. Error handling and conflict resolution

---

## Acceptance Criteria

- [ ] Opinion file schema finalized (all fields documented)
- [ ] Inheritance resolution algorithm fully specified
- [ ] CLI commands specified (`praxis opinions`, `--prompt`, `--check`, `--list`)
- [ ] AI agent integration pattern documented
- [ ] Conflict resolution rules defined
- [ ] Error cases documented (missing files, invalid yaml, etc.)
- [ ] Contract promoted from draft to active
- [ ] Schema version bumped to 1.0

---

## Contract Finalization

### 1. Finalized Schema

Update frontmatter based on structure learnings:

```yaml
---
domain: code                    # Required: code, create, write, learn, observe
stage: capture                  # Optional: stage scope
subtype: cli-python             # Optional: subtype path
inherits:                       # Optional: explicit inheritance
  - code
  - code/subtypes/cli
version: 1.0                    # Required: semver
status: active                  # Required: draft | active | deprecated
author: human | ai | hybrid     # Optional: attribution
last_reviewed: 2024-12-28       # Optional: freshness
---
```

### 2. Inheritance Algorithm

```python
def resolve_opinions(praxis_yaml):
    """
    Resolve applicable opinions for a project.
    Returns ordered list from general → specific.
    """
    opinions = []
    
    # 1. Shared principles (always apply)
    opinions.append("_shared/first-principles.md")
    
    # 2. Domain-level
    domain = praxis_yaml["domain"]
    opinions.append(f"{domain}/README.md")
    
    # 3. Stage-specific (if stage defined)
    if "stage" in praxis_yaml:
        stage = praxis_yaml["stage"]
        opinions.append(f"{domain}/{stage}.md")
    
    # 4. Subtype chain (if subtype defined)
    if "subtype" in praxis_yaml:
        subtype_path = praxis_yaml["subtype"].split("-")
        accumulated = f"{domain}/subtypes"
        for segment in subtype_path:
            accumulated += f"/{segment}"
            opinions.append(f"{accumulated}/README.md")
            if "stage" in praxis_yaml:
                opinions.append(f"{accumulated}/{stage}.md")
    
    # Filter to existing files only
    return [o for o in opinions if exists(o)]
```

### 3. CLI Commands

```bash
# Show resolved opinions for current project
praxis opinions
# Output: List of applicable opinion files, in resolution order

# Generate AI prompt with opinions embedded
praxis opinions --prompt
# Output: Markdown suitable for AI context

# Validate current work against opinion quality gates
praxis opinions --check
# Output: Pass/fail for each quality gate

# List all available opinion files (not just applicable)
praxis opinions --list
# Output: Tree of all opinion files

# Show opinions for specific domain/stage (without praxis.yaml)
praxis opinions --domain code --stage capture
```

### 4. AI Agent Integration

**CLAUDE.md addition:**

```markdown
## Opinions Framework

When working on a Praxis project:

1. Check if `docs/opinions/` exists
2. Read `praxis.yaml` to determine domain, stage, subtype
3. Resolve applicable opinions using inheritance:
   - _shared → domain → stage → subtype
4. Apply opinions as guidance (not hard rules)
5. Note any conflicts with user instructions

Run `praxis opinions --prompt` to get formatted context.
```

### 5. Conflict Resolution

When opinions conflict:
1. **Most specific wins:** Subtype overrides domain
2. **Explicit overrides implicit:** `inherits:` field overrides default chain
3. **User instruction wins:** User can override any opinion
4. **Log conflicts:** Tool should warn when conflict detected

### 6. Error Handling

| Error | Behavior |
|-------|----------|
| Missing `docs/opinions/` | Warning, no opinions applied |
| Invalid frontmatter | Error, skip file with message |
| Circular inheritance | Error, fail resolution |
| Missing inherited file | Warning, continue with available |

---

## Tasks

1. [ ] Finalize schema based on structure learnings
2. [ ] Implement inheritance algorithm (pseudo-code)
3. [ ] Specify CLI commands
4. [ ] Document AI agent integration
5. [ ] Document conflict resolution
6. [ ] Document error handling
7. [ ] Update `docs/opinions-contract.md` (remove -draft)
8. [ ] Version bump to 1.0
9. [ ] Review with stakeholder

---

## Dependencies

- 03-draft-praxis-contract-story (draft exists)
- 04-define-opinion-structure (structure validated)

## Blocks

- 05-tracer-bullet (needs finalized contract)
- CLI implementation
- AI agent tooling
- All remaining opinion research

---

## Notes

This story closes the loop on the contract definition. After this:
- Opinion authors have a stable format
- CLI implementers have a specification
- AI integration has a documented pattern
